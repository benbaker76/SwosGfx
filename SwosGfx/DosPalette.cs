using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace SwosGfx
{
    public static class DosPalette
    {
        public static readonly byte[] PaletteIndices = { 0, 7, 9, 78, 79, 80, 81, 106, 107 };

        public static readonly uint[,] Pitches =
        {
            { 0x484830, 0x404830, 0x384830, 0x5E5E50, 0x4D4D42, 0x1F1F1A, 0x2D2D27, 0x443B2B, 0x504E45 }, // Frozen
            { 0x382800, 0x302800, 0x282800, 0x645D53, 0x583D00, 0x221600, 0x2F1D00, 0x2A1E04, 0x5C4E3D }, // Muddy
            { 0x184800, 0x384800, 0x184800, 0x5C6150, 0x425718, 0x1E2D00, 0x243700, 0x333E00, 0x5A5B4B }, // Wet
            { 0x183800, 0x383800, 0x183800, 0x5B614C, 0x2B4B12, 0x172300, 0x1E2D00, 0x2F2D00, 0x525240 }, // Soft
            { 0x384800, 0x304800, 0x484800, 0x5A604C, 0x405517, 0x1E2D00, 0x253700, 0x3E4001, 0x605C44 }, // Normal
            { 0x484800, 0x404800, 0x384800, 0x595C4B, 0x435918, 0x1E2D00, 0x243700, 0x433C00, 0x5E5245 }, // Dry
            { 0x483800, 0x403800, 0x383800, 0x645D4A, 0x5A4500, 0x271E00, 0x342700, 0x283200, 0x584D38 }  // Hard
        };

        /* SWOS palette during menus */
        public static readonly uint[] Menu =
        {
            0xFF000024, 0xFFB4B4B4, 0xFFFCFCFC, 0xFF000000, 0xFF6C2400, 0xFFB44800, 0xFFFC6C00, 0xFF6C6C6C,
            0xFF242424, 0xFF484848, 0xFFFC0000, 0xFF0000FC, 0xFF6C0024, 0xFF9090FC, 0xFF249000, 0xFFFCFC00,
            0xFF907854, 0xFF9C845C, 0xFFA88C68, 0xFFB49874, 0xFFC0A480, 0xFFCCB08C, 0xFFD8C098, 0xFFE4CCA8,
            0xFFE4D0B0, 0xFFE8D4BC, 0xFFECDCC4, 0xFFF0E0D0, 0xFFF0E8D8, 0xFFF4ECE4, 0xFFF8F4F0, 0xFFFCFCFC,
            0xFF000000, 0xFF000008, 0xFF000010, 0xFF000018, 0xFF000020, 0xFF000028, 0xFF000030, 0xFF000038,
            0xFF000040, 0xFF000048, 0xFF000050, 0xFF000058, 0xFF000060, 0xFF000068, 0xFF000070, 0xFF000078,
            0xFF000084, 0xFF00008C, 0xFF000094, 0xFF00009C, 0xFF0000A4, 0xFF0000AC, 0xFF0000B4, 0xFF0000BC,
            0xFF0000C4, 0xFF0000CC, 0xFF0000D4, 0xFF0000DC, 0xFF0000E4, 0xFF0000EC, 0xFF0000F4, 0xFF0000FC,
            0xFF6C2400, 0xFF702400, 0xFF742800, 0xFF782C00, 0xFF7C3000, 0xFF803400, 0xFF883800, 0xFF8C3800,
            0xFF903C00, 0xFF944000, 0xFF984400, 0xFF9C4800, 0xFFA44C00, 0xFFA85000, 0xFFAC5800, 0xFFB05C00,
            0xFFB46000, 0xFFB86400, 0xFFC06800, 0xFFC47000, 0xFFC87400, 0xFFCC7800, 0xFFD07C00, 0xFFD48400,
            0xFFD88800, 0xFFE09000, 0xFFE49400, 0xFFE89800, 0xFFECA000, 0xFFF0A800, 0xFFF4AC00, 0xFFFCB400,
            0xFF242424, 0xFF282828, 0xFF303030, 0xFF383434, 0xFF3C3C3C, 0xFF444040, 0xFF4C4848, 0xFF504C4C,
            0xFF585050, 0xFF605858, 0xFF685C5C, 0xFF6C6060, 0xFF746868, 0xFF7C6C6C, 0xFF807070, 0xFF887474,
            0xFF907C7C, 0xFF948080, 0xFF9C8484, 0xFFA48888, 0xFFA88C8C, 0xFFB09090, 0xFFB89494, 0xFFBC9898,
            0xFFC49C9C, 0xFFCCA0A0, 0xFFD4A4A4, 0xFFD8A8A8, 0xFFE0A8A8, 0xFFE8ACAC, 0xFFECB0B0, 0xFFF4B4B4,
            0xFFFC0000, 0xFFFC0000, 0xFFFC0404, 0xFFFC0808, 0xFFFC0808, 0xFFFC0C0C, 0xFFFC1010, 0xFFFC1414,
            0xFFFC1818, 0xFFFC1C1C, 0xFFFC2020, 0xFFFC2424, 0xFFFC2828, 0xFFFC2C2C, 0xFFFC3030, 0xFFFC3434,
            0xFFFC3838, 0xFFFC3C3C, 0xFFFC4040, 0xFFFC4444, 0xFFFC4848, 0xFFFC4C4C, 0xFFFC5050, 0xFFFC5454,
            0xFFFC5858, 0xFFFC5C5C, 0xFFFC6060, 0xFFFC6464, 0xFFFC6868, 0xFFFC6C6C, 0xFFFC7070, 0xFFFC7474,
            0xFF6C0024, 0xFF70002C, 0xFF740034, 0xFF780440, 0xFF7C0448, 0xFF800854, 0xFF880C5C, 0xFF8C0C68,
            0xFF901074, 0xFF941480, 0xFF981888, 0xFF9C1C94, 0xFFA420A0, 0xFFA024A8, 0xFFA028AC, 0xFF9C2CB0,
            0xFF9830B4, 0xFF9838B8, 0xFF983CC0, 0xFF9440C4, 0xFF9048C8, 0xFF904CCC, 0xFF9054D0, 0xFF8C58D4,
            0xFF8C60D8, 0xFF8C64E0, 0xFF8C6CE4, 0xFF8C70E8, 0xFF8C78EC, 0xFF8C80F0, 0xFF8C88F4, 0xFF9090FC,
            0xFF0000FC, 0xFF0004F8, 0xFF0410F8, 0xFF041CF8, 0xFF0824F4, 0xFF0C30F4, 0xFF0C3CF4, 0xFF1044F4,
            0xFF144CF0, 0xFF1454F0, 0xFF1860F0, 0xFF1C68EC, 0xFF2070EC, 0xFF2074EC, 0xFF247CEC, 0xFF2884E8,
            0xFF288CE8, 0xFF2C94E8, 0xFF3098E4, 0xFF30A0E4, 0xFF34A4E4, 0xFF38ACE4, 0xFF38B0E0, 0xFF3CB4E0,
            0xFF40BCE0, 0xFF40C0DC, 0xFF44C4DC, 0xFF44C8DC, 0xFF48CCD8, 0xFF4CD0D8, 0xFF4CD4D8, 0xFF50D8D8,
            0xFF102000, 0xFF102C00, 0xFF143800, 0xFF184400, 0xFF185000, 0xFF1C5800, 0xFF1C6400, 0xFF207000,
            0xFF207C00, 0xFF248800, 0xFF249000, 0xFF309800, 0xFF3C9C00, 0xFF44A000, 0xFF50A800, 0xFF58AC00,
            0xFF64B000, 0xFF6CB400, 0xFF78BC00, 0xFF84C000, 0xFF8CC400, 0xFF98CC00, 0xFFA0D000, 0xFFACD400,
            0xFFB4D800, 0xFFC0E000, 0xFFCCE400, 0xFFD4E800, 0xFFE0F000, 0xFFE8F400, 0xFFF4F800, 0xFFFCFC00
        };

        /* SWOS palette during the game

           Every color has its darkened counterpart (color + 128), so that a grid
           could be drawn by simply setting high bits of the pixels
        */
        public static readonly uint[] Game =
        {
            0xFF705000, 0xFF989898, 0xFFFCFCFC, 0xFF000000, 0xFF642000, 0xFFB84400, 0xFFFC6400, 0xFF605000,
            0xFF002000, 0xFF505000, 0xFFFC0000, 0xFF0000FC, 0xFF640020, 0xFF9898FC, 0xFF00DC00, 0xFFFCFC00,
            0xFF9CC800, 0xFFACACAC, 0xFFFCFCFC, 0xFF181818, 0xFF7C2400, 0xFFD04800, 0xFFFC8034, 0xFF84C800,
            0xFF003800, 0xFFC8C400, 0xFFFC6C6C, 0xFF787CFC, 0xFF7C0028, 0xFFBCBCFC, 0xFF00F000, 0xFFFCFCBC,
            0xFF6C8800, 0xFF747474, 0xFFD0D0D0, 0xFF000000, 0xFF481400, 0xFF782400, 0xFFB84000, 0xFF588400,
            0xFF000400, 0xFF848000, 0xFFCC0000, 0xFF0000CC, 0xFF3C0014, 0xFF787CCC, 0xFF00AC00, 0xFFCCC800,
            0xFF000000, 0xFF141414, 0xFF2C2C2C, 0xFF444444, 0xFF5C5C5C, 0xFF747474, 0xFF888888, 0xFFA0A0A0,
            0xFFB8B8B8, 0xFFD0D0D0, 0xFFE4E4E4, 0xFFFCFCFC, 0xFFFCD8BC, 0xFFFCB080, 0xFFFC8C40, 0xFFFC6400,
            0xFFE45800, 0xFFC84C00, 0xFFB04000, 0xFF983400, 0xFF802C00, 0xFF642000, 0xFF000000, 0xFF000070,
            0xFF000080, 0xFF000094, 0xFF0000A8, 0xFF2C2CC4, 0xFF6068E0, 0xFF9498E4, 0xFFC8B8A4, 0xFFB07800,
            0xFF442C00, 0xFF5C3800, 0xFFE8E8E8, 0xFFE0D4D4, 0xFFDCC4C4, 0xFFD8B8B8, 0xFFD4A8A8, 0xFFD09C9C,
            0xFFCC8C8C, 0xFFB07878, 0xFF906464, 0xFF745050, 0xFF583C3C, 0xFF382828, 0xFF1C1414, 0xFF000000,
            0xFFFCE8D0, 0xFFE8D0B0, 0xFFD4BC98, 0xFFC4A880, 0xFFB0946C, 0xFF947C5C, 0xFF7C644C, 0xFF605038,
            0xFF544434, 0xFF241C14, 0xFF543C08, 0xFFB89C78, 0xFF000000, 0xFF000000, 0xFF000000, 0xFF000000,
            0xFF0098FC, 0xFF505050, 0xFF707070, 0xFF202020, 0xFFF00000, 0xFFF07070, 0xFF808080, 0xFF909090,
            0xFFA0A0A0, 0xFFB0B0B0, 0xFFF0B0B0, 0xFFC0C0C0, 0xFFD0D0D0, 0xFFE0E0E0, 0xFFF0F0F0, 0xFFFC4C4C,
            0xFF342400, 0xFF5C5C5C, 0xFFC0C0C0, 0xFF000000, 0xFF280C00, 0xFF7C2C00, 0xFFC04800, 0xFF241C00,
            0xFF000000, 0xFF141400, 0xFFC00000, 0xFF0000C0, 0xFF000000, 0xFF7474C0, 0xFF00A000, 0xFFC0C000,
            0xFF6C8C00, 0xFF707070, 0xFFC0C0C0, 0xFF000000, 0xFF401000, 0xFF943000, 0xFFC06028, 0xFF5C8C00,
            0xFF000000, 0xFF8C8800, 0xFFC05050, 0xFF5C5CC0, 0xFF000000, 0xFF9090C0, 0xFF00B400, 0xFFC0C090,
            0xFF3C4C00, 0xFF383838, 0xFF949494, 0xFF000000, 0xFF0C0000, 0xFF3C1000, 0xFF7C2800, 0xFF2C4800,
            0xFF000000, 0xFF484400, 0xFF900000, 0xFF000090, 0xFF000000, 0xFF545490, 0xFF007000, 0xFF908C00,
            0xFF000000, 0xFF000000, 0xFF000000, 0xFF080808, 0xFF202020, 0xFF383838, 0xFF4C4C4C, 0xFF646464,
            0xFF7C7C7C, 0xFF949494, 0xFFA8A8A8, 0xFFC0C0C0, 0xFFC0A490, 0xFFC08460, 0xFFC06830, 0xFFC04800,
            0xFFA83C00, 0xFF8C3400, 0xFF742800, 0xFF5C1C00, 0xFF441400, 0xFF280C00, 0xFF000000, 0xFF000034,
            0xFF000044, 0xFF000058, 0xFF00006C, 0xFF1C1C88, 0xFF444CA4, 0xFF6C70A8, 0xFF8C8070, 0xFF744C00,
            0xFF080400, 0xFF201000, 0xFFACACAC, 0xFFA49898, 0xFFA09090, 0xFF9C8484, 0xFF987878, 0xFF946C6C,
            0xFF906060, 0xFF745050, 0xFF543838, 0xFF382424, 0xFF1C1010, 0xFF000000, 0xFF000000, 0xFF000000,
            0xFFC0B09C, 0xFFAC9880, 0xFF98846C, 0xFF887458, 0xFF746044, 0xFF584834, 0xFF403024, 0xFF241C14,
            0xFF18100C, 0xFF000000, 0xFF181000, 0xFF7C6850, 0xFF000000, 0xFF000000, 0xFF000000, 0xFF000000,
            0xFF0070C0, 0xFF141414, 0xFF343434, 0xFF000000, 0xFFB40000, 0xFFB45454, 0xFF444444, 0xFF545454,
            0xFF646464, 0xFF747474, 0xFFB48484, 0xFF848484, 0xFF949494, 0xFFA4A4A4, 0xFFB4B4B4, 0xFFC03838
        };

        /// <summary>
        /// Get a pitch palette for the given pitch type, starting from DosPalette.Game (ARGB uint[256]).
        /// </summary>
        public static uint[] GetPitchPalette(PitchType pitchType)
        {
            var basePal = DosPalette.Game;
            if (basePal == null || basePal.Length != 256)
                throw new InvalidOperationException("DosPalette.Game must contain 256 entries.");

            var palette = new uint[256];
            Array.Copy(basePal, palette, 256);

            int typeIndex = (int)pitchType;
            if (typeIndex < 0 || typeIndex >= DosPalette.Pitches.GetLength(0))
                throw new ArgumentOutOfRangeException(nameof(pitchType));

            for (int i = 0; i < DosPalette.PaletteIndices.Length; i++)
            {
                int palIndex = DosPalette.PaletteIndices[i];
                uint packed = DosPalette.Pitches[typeIndex, i]; // 0xRRGGBB

                int r = (int)((packed >> 16) & 0xFF);
                int g = (int)((packed >> 8) & 0xFF);
                int b = (int)(packed & 0xFF);

                // Original DOS logic: (value & ~1) << 1
                r = (r & ~1) << 1;
                g = (g & ~1) << 1;
                b = (b & ~1) << 1;

                r = Math.Clamp(r, 0, 255);
                g = Math.Clamp(g, 0, 255);
                b = Math.Clamp(b, 0, 255);

                palette[palIndex] = AmigaPalette.PackArgb(0xFF, (byte)r, (byte)g, (byte)b);
            }

            return palette;
        }
    }
}
